<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        background: #fafafa;
        font-family: Arial, Helvetica, sans-serif;
      }
    </style>
  </head>
  <body>
    <holochain-playground-container id="container">
      <div
        style="
          display: flex;
          flex-direction: row;
          align-items: start;
          margin-bottom: 20px;
        "
      >
        <dht-cells
          id="cells"
          style="height: 600px; width: 1000px"
          show-zome-fn-success
          skip-genesis
        ></dht-cells>
        <run-steps style="height: 600px; width: 400px"></run-steps>
      </div>
      <div
        style="
          display: flex;
          height: 400px;
          flex-direction: row;
          align-items: start;
          margin-bottom: 20px;
        "
      >
        <call-zome-fns
          style="height: 350px; flex: 1"
          id="call-zome"
        ></call-zome-fns>
        <source-chain style="height: 350px; flex: 1"></source-chain>
        <entry-contents style="height: 350px; flex: 1"></entry-contents>
      </div>
    </holochain-playground-container>

    <script type="module">
      import '@webcomponents/scoped-custom-element-registry';
      import { html, render } from 'lit';
      import {
        HolochainPlaygroundContainer,
        CallZomeFns,
        SourceChain,
        SelectActiveDna,
        ConductorAdmin,
        DhtCells,
        ZomeFnsResults,
        EntryGraph,
        EntryContents,
        RunSteps,
      } from '../dist';
      import {
        GetStrategy,
        WorkflowType,
        NetworkRequestType,
      } from '@holochain-playground/core';

      customElements.define(
        'holochain-playground-container',
        HolochainPlaygroundContainer
      );
      customElements.define('run-steps', RunSteps);
      customElements.define('dht-cells', DhtCells);
      customElements.define('select-active-dna', SelectActiveDna);
      customElements.define('call-zome-fns', CallZomeFns);
      customElements.define('source-chain', SourceChain);
      customElements.define('entry-graph', EntryGraph);
      customElements.define('zome-fns-results', ZomeFnsResults);
      customElements.define('entry-contents', EntryContents);
      customElements.define('conductor-admin', ConductorAdmin);

      const container = document.getElementById('container');
      container.numberOfSimulatedConductors = 10;

      let headerHash = undefined;
      const steps = [
        {
          title: (context) =>
            `${context.conductors[1].name} (an honest agent) creates an entry`,
          run: async (context) => {
            const cell = context.conductors[1].getAllCells()[0];
            headerHash = await context.conductors[1].callZomeFn({
              cellId: cell.cellId,
              zome: 'demo_entries',
              fnName: 'create_entry',
              payload: { content: 'Good morning!' },
              cap: null,
            });
          },
        },
        {
          title: (context) =>
            `${context.conductors[5].name} (an honest agent) tries to update that same entry`,
          run: async (context) => {
            const cell = context.conductors[5].getAllCells()[0];

            try {
              await context.conductors[5].callZomeFn({
                cellId: cell.cellId,
                zome: 'demo_entries',
                fnName: 'update_entry',
                payload: {
                  original_header_address: headerHash,
                  new_content: 'Bad morning!',
                },
                cap: null,
              });
            } catch (e) {}
          },
        },
      ];

      container.addEventListener('ready', (e) => {
        const conductors = e.detail.conductors;
        const conductor = conductors[0];

        for (let i = 5; i < 6; i++) {
          conductors[i].setBadAgent({
            disable_validation_before_publish: true,
            pretend_invalid_elements_are_valid: true,
          });
        }

        const cellId = conductor.getAllCells()[0].cellId;

        container.activeDna = cellId[0];
        e.target.querySelector('run-steps').steps = steps;
      });
    </script>
  </body>
</html>
